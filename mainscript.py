import os
from datetime import datetime
from config import *
from utils import virustotal_api
from StaticMalwareAnalysis import StaticMalwareAnalysis


if StaticMalwareAnalysis.check_malware_sample_exists():
    
    malware_samples = os.listdir(config['malware-sample-folder'])
    
    # Loop through each sample for analysis
    for sample_name in malware_samples:
        print(f"Initiating analysis for {sample_name} at {str(datetime.now())}")
        
       
        malware_analysis = StaticMalwareAnalysis(os.path.join(config['malware-sample-folder'], sample_name))
        
        
        analysis_directory = malware_analysis.create_directory()
        print(f"Analysis Directory Created: {analysis_directory}")
        
        # Calculate the SHA-256 hash of the sample
        sha256_hash = malware_analysis.get_sha256sum()
        print(f"SHA-256 Hash: {sha256_hash}")
        
        # Extract strings from the sample
        malware_analysis.extract_strings()
        
        
        malware_analysis.extractPEINFO()
        print("PE Info Extracted")
        
       
        malware_analysis.move_malware()
        print("Malware sample moved to the saved analysis folder")
        
       
        virustotal_results = virustotal_api(sha256_hash)
        malware_analysis.set_virustotal_results(virustotal_results)
        
        # Generate PDF and HTML reports
        malware_analysis.create_pdf()
        print("PDF/HTML Reports Created")
